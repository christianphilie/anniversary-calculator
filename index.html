<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jubil√§ums-Finder v10</title>
  <meta name="description" content="Berechne besondere Meilensteine wie 10 Jahre, 500 Wochen oder 333.333 Sekunden und exportiere sie als Kalender" />
  <style>
    /* ========= Tokens ========= */
    :root{
      --bg:#fff; --panel:#f6f7fb; --card:#fff; --text:#111; --muted:#555;
      --border:#e5e7eb; --radius:14px;
      --brand:#0ea5e9; --accent:#8b5cf6;
      /* Unit scale (seconds‚Üíyears) ‚Äî new scheme */
      --c-seconds:#3b82f6; --c-minutes:#06b6d4; --c-hours:#10b981;
      --c-days:#82c55e; --c-weeks:#f59e0b; --c-months:#f97316; --c-years:#ef4444;
      /* Buttons: black in light */
      --btn-bg:#111; --btn-fg:#fff; --btn-border:transparent;
      --focus: 0 0 0 3px rgba(14,165,233,.25);
    }
    [data-theme="dark"]{
      --bg:#0b0c0f; --panel:#101319; --card:#141821; --text:#e9eef5; --muted:#a3adba;
      --border:#1f2530; --radius:16px;
      --brand:#7dd3fc; --accent:#a78bfa;
      --c-seconds:#60a5fa; --c-minutes:#22d3ee; --c-hours:#34d399;
      --c-days:#8ade80; --c-weeks:#f5ae0b; --c-months:#fb823c; --c-years:#f87171;
      /* Buttons: white in dark */
      --btn-bg:#fff; --btn-fg:#111; --btn-border:transparent;
      --focus: 0 0 0 3px rgba(125,211,252,.25);
    }

    /* ========= Base/Layout ========= */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;color:var(--text);background:var(--bg);transition:background .25s,color .25s}
    .wrap{max-width:1200px;margin:0 auto;padding:28px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    .title{display:flex;gap:12px;align-items:center}
    .logo{font-size:28px;line-height:1}
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted)}

    .grid{display:grid;grid-template-columns: minmax(260px,320px) minmax(0,1fr);gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
    .panel .hd{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .panel .bd{padding:18px}

    form .field{display:grid;gap:8px;margin-bottom:14px}
    label{font-size:13px;color:var(--muted)}
    input[type="text"],input[type="date"],input[type="time"],select{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:12px;font-size:14px;width:100%}
    input[type="checkbox"]{width:16px;height:16px}
    .row{display:flex;gap:10px}
    .row>*{flex:1}

    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:999px;font-size:13px;user-select:none}
    .chip input{accent-color: currentColor}

    /* Unit color on checkbox/label */
    .chip.unit.seconds{color:var(--c-seconds)}
    .chip.unit.minutes{color:var(--c-minutes)}
    .chip.unit.hours{color:var(--c-hours)}
    .chip.unit.days{color:var(--c-days)}
    .chip.unit.weeks{color:var(--c-weeks)}
    .chip.unit.months{color:var(--c-months)}
    .chip.unit.years{color:var(--c-years)}
    .chip input:checked + span{font-weight:700}

    /* Buttons (normalize sizes) */
    .btn{appearance:none;cursor:pointer;font-weight:700;border-radius:12px;padding:12px 14px;font-size:14px;line-height:1.1}
    .btn.primary{background:var(--btn-bg);color:var(--btn-fg);border:1px solid var(--btn-border)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.ghost{background:transparent;color:var(--muted);border:none;padding:0}
    .btn.small{padding:6px 10px;font-weight:600;font-size:12px;border-radius:999px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:focus-visible{outline:none;box-shadow:var(--focus)}

    /* Segmented 3-way theme switch (restored unified pill) */
    .seg{display:inline-flex;gap:0;background:var(--card);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .seg button{border:0;background:transparent;padding:8px 12px;cursor:pointer;font-size:13px;color:var(--muted);line-height:1}
    .seg button+.seg button{border-left:1px solid transparent}
    .seg button[aria-pressed="true"]{background:var(--panel);color:var(--text);font-weight:700}
    .seg button:focus-visible{outline:none;box-shadow:var(--focus)}
    /* make buttons look connected */
    .seg button:first-child{border-right:1px solid var(--border)}
    .seg button:nth-child(2){border-right:1px solid var(--border)}
    .seg button:last-child{border-right:0}

    /* Results list */
    .list{display:grid;gap:10px}
    .year-sep{margin-top:8px;padding:6px 0;color:var(--muted);font-weight:700;font-size:12px;display:flex;align-items:center;gap:10px}
    .year-sep .y{flex:1}
    .item{display:flex;gap:14px;align-items:center;background:var(--card);border:1px solid var(--border);padding:12px;border-radius:14px}
    .when{font-weight:700}
    .when .since{font-weight:400;color:var(--muted)}
    .sub{font-size:12px;color:var(--muted)}
    .grow{flex:1;min-width:0}
    .tag{font-size:12px;color:#fff;padding:3px 8px;border-radius:999px;font-weight:800;margin-left:auto;white-space:nowrap}
    .tag.years{background:var(--c-years)} .tag.months{background:var(--c-months)}
    .tag.weeks{background:var(--c-weeks)} .tag.days{background:var(--c-days)}
    .tag.hours{background:var(--c-hours)} .tag.minutes{background:var(--c-minutes)} .tag.seconds{background:var(--c-seconds)}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar .push-right{margin-left:auto}

    .empty{padding:18px;background:var(--card);border:1px solid var(--border);border-radius:12px;text-align:center;color:var(--muted)}

    /* Pretty native-like select with chevron */
    select{
      appearance:none;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:16px;
      padding-right:36px;
    }
    [data-theme="dark"] select{
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23a3adba' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    }
  </style>
</head>
<body data-theme="light" data-theme-mode="system">
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true">üéâ</div>
        <div>
          <h1>Jubil√§ums-Finder</h1>
          <div class="muted">Berechne besondere Meilensteine & exportiere sie als Kalender</div>
        </div>
      </div>
      <div class="seg" role="group" aria-label="Darstellung">
        <button data-mode="light" aria-pressed="false" title="Hell">‚òÄÔ∏è Hell</button>
        <button data-mode="dark" aria-pressed="false" title="Dunkel">üåô Dunkel</button>
        <button data-mode="system" aria-pressed="true" title="System">üíª System</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="hd">
          <strong>üéØ Eingaben</strong>
          <button id="btnReset" class="btn ghost" title="Eingaben zur√ºcksetzen" style="margin-left:auto">Zur√ºcksetzen</button>
        </div>
        <div class="bd">
          <form id="form">
            <div class="field">
              <label for="label">Titel (optional)</label>
              <input id="label" type="text" placeholder="Kennenlernen, Geburt, Hochzeit ‚Ä¶" />
            </div>

            <div class="row">
              <div class="field">
                <label for="date">Datum</label>
                <input id="date" type="date" required />
              </div>
              <div class="field">
                <label for="time">Uhrzeit (optional)</label>
                <input id="time" type="time" step="1" />
              </div>
            </div>

            <div class="field">
              <label>Einheiten</label>
              <div class="chips">
                <label class="chip unit years"><input type="checkbox" name="unit" value="years" checked /><span>Jahre</span></label>
                <label class="chip unit months"><input type="checkbox" name="unit" value="months" checked /><span>Monate</span></label>
                <label class="chip unit weeks"><input type="checkbox" name="unit" value="weeks" checked /><span>Wochen</span></label>
                <label class="chip unit days"><input type="checkbox" name="unit" value="days" checked /><span>Tage</span></label>
                <label class="chip unit hours"><input type="checkbox" name="unit" value="hours" checked /><span>Stunden</span></label>
                <label class="chip unit minutes"><input type="checkbox" name="unit" value="minutes" checked /><span>Minuten</span></label>
                <label class="chip unit seconds"><input type="checkbox" name="unit" value="seconds" checked /><span>Sekunden</span></label>
              </div>
            </div>

            <div class="field">
              <label>Muster</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" name="pattern" value="rounded" checked /><span>Runde Vielfache (500, 10.000, ‚Ä¶)</span></label>
                <label class="chip"><input type="checkbox" name="pattern" value="repdigit" checked /><span>Schnapszahlen (11, 2.222, 333, ‚Ä¶)</span></label>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="yearFrom">Jahre von</label>
                <select id="yearFrom"></select>
              </div>
              <div class="field">
                <label for="yearTo">Jahre bis</label>
                <select id="yearTo"></select>
              </div>
            </div>
          </form>
        </div>
      </section>

      <section class="panel">
        <div class="hd">
          <strong>üìä Meilensteine</strong>
          <div class="toolbar" style="width:100%">
            <button class="btn secondary" id="btnSelectAll"  title="Alle sichtbaren Eintr√§ge ausw√§hlen">‚úÖ Alle ausw√§hlen</button>
            <button class="btn secondary" id="btnSelectNone" title="Auswahl sichtbarer Eintr√§ge aufheben">üö´ Alle abw√§hlen</button>
            <button class="btn primary push-right" id="btnIcsSel" title="Keine ausgew√§hlten sichtbaren Eintr√§ge" disabled>üìÖ Kalenderdatei herunterladen</button>
          </div>
        </div>

        <div class="bd">
          <div id="results">
            <div class="empty">Noch nichts berechnet. W√§hle ein Datum.</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

    // Theme segmented switch
    const body=document.body;
    const mm=window.matchMedia('(prefers-color-scheme: dark)');
    function applyTheme(mode){
      if(mode==='system'){ body.setAttribute('data-theme', mm.matches?'dark':'light'); body.dataset.themeMode='system'; }
      else { body.setAttribute('data-theme', mode); body.dataset.themeMode=mode; }
      $$('.seg button').forEach(b=>b.setAttribute('aria-pressed','false'));
      const btn=$(`.seg button[data-mode="${mode}"]`); if(btn) btn.setAttribute('aria-pressed','true');
      localStorage.setItem('themeMode', mode);
    }
    $$('.seg button').forEach(b=>b.addEventListener('click',()=>applyTheme(b.dataset.mode)));
    mm.addEventListener?.('change',()=>{ if((localStorage.getItem('themeMode')||'system')==='system') applyTheme('system'); });
    applyTheme(localStorage.getItem('themeMode')||'system');

    // Intl
    const fmtFull=new Intl.DateTimeFormat('de-DE',{dateStyle:'full',timeStyle:'short'});
    const fmtNum=new Intl.NumberFormat('de-DE');

    // Durations
    const MS={second:1000,minute:60000,hour:3600000,day:86400000,week:604800000};

    // Date math with clamping for months/years
    function dim(y,m){return new Date(y,m+1,0).getDate();}
    function addYears(d,n){const dt=new Date(d.getTime());const y=dt.getFullYear()+n,m=dt.getMonth();dt.setFullYear(y,m,Math.min(dt.getDate(),dim(y,m)));return dt;}
    function addMonths(d,n){const dt=new Date(d.getTime());const y=dt.getFullYear(),m=dt.getMonth();const t=m+n;const ny=y+Math.floor(t/12);const nm=((t%12)+12)%12;dt.setFullYear(ny,nm,Math.min(dt.getDate(),dim(ny,nm)));return dt;}
    const addWeeks=(d,n)=>new Date(d.getTime()+n*MS.week);
    const addDays=(d,n)=>new Date(d.getTime()+n*MS.day);
    const addHours=(d,n)=>new Date(d.getTime()+n*MS.hour);
    const addMinutes=(d,n)=>new Date(d.getTime()+n*MS.minute);
    const addSeconds=(d,n)=>new Date(d.getTime()+n*MS.second);

    // Patterns
    const K_SET=[1,2,3,4,5,6,7,8,9];
    function isPowerOf10(n){ if(n<10) return false; while(n%10===0) n/=10; return n===1; }
    function isKTimesPow10(n){ let m=n; while(m%10===0) m/=10; return K_SET.includes(m); }
    function isRounded(n){ return isPowerOf10(n) || isKTimesPow10(n); }
    function isRepdigit(n){ const s=String(n); return s.length>1 && /^([1-9])\1+$/.test(s); }

    function makePowersOf10(max){const set=new Set(); for(let k=1;10**k<=max;k++) set.add(10**k); return set;}
    function makeKTimesPow10(max){const set=new Set(); for(const K of K_SET){ for(let k=0;;k++){ const v=K*10**k; if(v>max) break; set.add(v);} } return set;}
    function makeRepdigits(max){const set=new Set(); for(let len=2;len<=12;len++){ for(let d=1;d<=9;d++){ const v=Number(String(d).repeat(len)); if(v<=max) set.add(v); } } return set;}

    function buildCandidates(maxN, patterns){
      const s=new Set();
      if(patterns.rounded){ for(const v of makePowersOf10(maxN)) s.add(v); for(const v of makeKTimesPow10(maxN)) s.add(v); }
      if(patterns.repdigit){ for(const v of makeRepdigits(maxN)) s.add(v); }
      return Array.from(s).sort((a,b)=>a-b);
    }

    function classifyPatterns(n){ return { rounded:isRounded(n), repdigit:isRepdigit(n) }; }

    // Grammar (Dativ) with future/past
    const unitDE={years:['Jahr','Jahre','Jahren'],months:['Monat','Monate','Monaten'],weeks:['Woche','Wochen','Wochen'],days:['Tag','Tage','Tagen'],hours:['Stunde','Stunden','Stunden'],minutes:['Minute','Minuten','Minuten'],seconds:['Sekunde','Sekunden','Sekunden']};
    const labelDE=(u,n)=> (n===1?unitDE[u][0]:unitDE[u][1]);
    const dativeDE=(u,n)=> (n===1?unitDE[u][0]:unitDE[u][2]);

    function humanDiff(from,to){
      const future = to>=from;
      let ms=Math.abs(to-from), s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24), mo=Math.floor(d/30.44), y=Math.floor(d/365.2425);
      const prefix = future ? 'in ' : 'vor ';
      if(y>0) return `${prefix}${y} ${dativeDE('years',y)}`;
      if(mo>0) return `${prefix}${mo} ${dativeDE('months',mo)}`;
      const w=Math.floor(d/7);
      if(w>0) return `${prefix}${w} ${dativeDE('weeks',w)}`;
      if(d>0) return `${prefix}${d} ${dativeDE('days',d)}`;
      if(h>0) return `${prefix}${h} ${dativeDE('hours',h)}`;
      if(m>0) return `${prefix}${m} ${dativeDE('minutes',m)}`;
      return `${prefix}${s} ${dativeDE('seconds',s)}`;
    }

    // ICS helpers (mixed all-day/timed)
    const isoUTC=d=>d.getUTCFullYear().toString()+
      String(d.getUTCMonth()+1).padStart(2,'0')+
      String(d.getUTCDate()).padStart(2,'0')+'T'+
      String(d.getUTCHours()).padStart(2,'0')+
      String(d.getUTCMinutes()).padStart(2,'0')+
      String(d.getUTCSeconds()).padStart(2,'0')+'Z';
    const ymdUTC=d=>d.getUTCFullYear().toString()+String(d.getUTCMonth()+1).padStart(2,'0')+String(d.getUTCDate());
    const esc=s=>s.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");

    function buildICS(events){
      const now=new Date(); const out=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//JubilaeumsFinder//DE','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
      for(const ev of events){
        out.push('BEGIN:VEVENT',`UID:${ev.id}@jubilaeum`,`DTSTAMP:${isoUTC(now)}`,`SUMMARY:${esc(ev.baseTitle)} ${esc(ev.since)}`,`DESCRIPTION:${esc(ev.desc)}`);
        if(['days','weeks','months','years'].includes(ev.unit)){
          const start=new Date(ev.date); const end=new Date(start.getTime()+MS.day);
          out.push(`DTSTART;VALUE=DATE:${ymdUTC(start)}`,`DTEND;VALUE=DATE:${ymdUTC(end)}`);
        }else{
          const start=new Date(ev.date); const end=new Date(start.getTime()+MS.hour);
          out.push(`DTSTART:${isoUTC(start)}`,`DTEND:${isoUTC(end)}`);
        }
        out.push('END:VEVENT');
      }
      out.push('END:VCALENDAR'); return out.join('\r\n');
    }
    function download(name,content){ const blob=new Blob([content],{type:'text/calendar;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }

    // Core compute (windowed) with per-unit minimal N near the start moment
    const unitAdder=u=>({years:addYears,months:addMonths,weeks:addWeeks,days:addDays,hours:addHours,minutes:addMinutes,seconds:addSeconds})[u];
    const unitMs=u=>({weeks:MS.week,days:MS.day,hours:MS.hour,minutes:MS.minute,seconds:MS.second})[u]||null;
    const diffMonths=(a,b)=>(b.getFullYear()-a.getFullYear())*12+(b.getMonth()-a.getMonth());
    const yearsBetween=(a,b)=>Math.floor((b-a)/MS.day/365.2425);

    // Sensible minimum milestones to avoid noise close to start
    const MIN_N={ seconds:10_000_000, minutes:100_000, hours:1_000, days:100, weeks:10, months:10, years:1 };

    /**
     * Compute events within [from, to] window (inclusive).
     */
    function computeRangeWindow(start, opts, from, to){
      const evs=[];
      function push(date,n,unit){
        if(date<from || date>to) return;
        if(n < MIN_N[unit]) return;
        const baseTitle=`${fmtNum.format(n)} ${labelDE(unit,n)}`;
        const since=`seit ${opts.label||'Start'}`;
        const startText=new Intl.DateTimeFormat('de-DE',{dateStyle:'long',timeStyle:'short'}).format(start)+' Uhr';
        const desc=`${fmtNum.format(n)} ${labelDE(unit,n)} seit ${startText}`;
        evs.push({id:`${unit}-${n}-${date.getTime()}`,unit,n,date,baseTitle,since,inHuman:humanDiff(new Date(),date),desc,patterns:classifyPatterns(n)});
      }
      for(const unit of opts.units){
        const add=unitAdder(unit);
        if(unit==='years'){
          const maxN=yearsBetween(start,to)+2;
          for(const n of buildCandidates(maxN,opts.patterns)) push(add(start,n),n,unit);
        }else if(unit==='months'){
          const maxN=diffMonths(start,to)+2;
          for(const n of buildCandidates(maxN,opts.patterns)) push(add(start,n),n,unit);
        }else{
          const per=unitMs(unit), maxN=Math.floor((to-start)/per)+1;
          for(const n of buildCandidates(maxN,opts.patterns)) push(add(start,n),n,unit);
        }
      }
      evs.sort((a,b)=>a.date-b.date||a.n-b.n); return evs;
    }

    // ---------- State ----------
    const state={
      start:null,label:'',
      units:['years','months','weeks','days','hours','minutes','seconds'],
      patterns:{rounded:true,repdigit:true},
      eventsAll:[],eventsView:[],selected:new Set(),
      yearFrom:null, yearTo:null, // absolute calendar years
    };

    // ---------- URL persistence ----------
    function encodeStateToURL(){
      const params=new URLSearchParams();
      if(state.label) params.set('l',state.label);
      if(state.start){
        params.set('d',$('#date').value);
        params.set('t',$('#time').value||'');
        params.set('yf',String(state.yearFrom));
        params.set('yt',String(state.yearTo));
      }
      params.set('u',state.units.join(','));
      params.set('p',Object.entries(state.patterns).filter(([,v])=>v).map(([k])=>k).join(','));
      const mode=localStorage.getItem('themeMode'); if(mode) params.set('theme',mode);
      history.replaceState(null,'','?'+params.toString());
    }

    function loadStateFromURL(){
      const q=new URLSearchParams(location.search);
      if(q.get('l')) $('#label').value=q.get('l');
      if(q.get('d')) $('#date').value=q.get('d');
      if(q.get('t')) $('#time').value=q.get('t');
      const u=q.get('u'); if(u){ const set=new Set(u.split(',').filter(Boolean)); $$('#form input[name="unit"]').forEach(i=>i.checked=set.has(i.value)); }
      const p=q.get('p'); if(p){ const set=new Set(p.split(',').filter(Boolean)); $$('#form input[name="pattern"]').forEach(i=>i.checked=set.has(i.value)); }
      const theme=q.get('theme'); if(theme){ applyTheme(theme); }
    }

    // ---------- Year selects ----------
    const MAX_SPAN = 300; // max future span from start year

    function fillYearFromSelect(startYear){
      const sel=$('#yearFrom');
      sel.innerHTML='';
      for(let y=startYear; y<=startYear+MAX_SPAN; y++){
        const opt=document.createElement('option');
        opt.value=String(y); opt.textContent=String(y);
        sel.appendChild(opt);
      }
    }
    function fillYearToSelect(startYear, fromYear){
      const sel=$('#yearTo');
      sel.innerHTML='';
      const maxY = startYear + MAX_SPAN;
      for(let y=fromYear; y<=maxY; y++){
        const opt=document.createElement('option');
        opt.value=String(y); opt.textContent=String(y);
        sel.appendChild(opt);
      }
    }

    function setDefaultYearRange(startYear){
      const todayYear = new Date().getFullYear();
      const wantedTo = Math.max(startYear + 10, todayYear + 10);
      const cappedTo = Math.min(startYear + MAX_SPAN, wantedTo);
      state.yearFrom = startYear;
      state.yearTo   = cappedTo;
      $('#yearFrom').value = String(state.yearFrom);
      fillYearToSelect(startYear, state.yearFrom);
      $('#yearTo').value = String(state.yearTo);
    }

    function ensureYearRangeValidity(){
      const startYear = state.start.getFullYear();

      // aktuelle Werte aus den Selects lesen
      const currentFromSel = parseInt($('#yearFrom').value || startYear, 10);
      const currentToSel   = $('#yearTo').value ? parseInt($('#yearTo').value, 10) : null;

      // clamp FROM: nie vor Startjahr, nie hinter max
      const minFrom = startYear;
      const maxTo   = startYear + MAX_SPAN;
      let from = Math.max(minFrom, Math.min(currentFromSel, maxTo));

      // Nur wenn sich FROM ge√§ndert hat, die TO-Optionen neu f√ºllen
      const prevFromInState = state.yearFrom ?? startYear;
      if (from !== prevFromInState) {
        fillYearToSelect(startYear, from);
      }

      // clamp TO: mindestens FROM, h√∂chstens maxTo
      let to = currentToSel !== null ? currentToSel : from;
      to = Math.min(maxTo, Math.max(from, to));

      // Werte in DOM und State zur√ºckschreiben
      $('#yearFrom').value = String(from);
      // Falls 'to' nach dem evtl. Neubau nicht existiert, wird der Browser die erste Option w√§hlen.
      // Wir setzen daher explizit:
      $('#yearTo').value = String(to);

      state.yearFrom = from;
      state.yearTo   = to;
    }

    // ---------- Compute & Render ----------
    function getOptsFromForm(){
      const label=$('#label').value.trim();
      const dateStr=$('#date').value; if(!dateStr) return null;
      const timeStr=$('#time').value||'12:00:00';
      const [hh,mm,ss='00']=timeStr.split(':');
      const [y,m,d]=dateStr.split('-').map(Number);
      const start=new Date(y,m-1,d,Number(hh),Number(mm),Number(ss));
      const units=$$('input[name="unit"]:checked').map(x=>x.value);
      const patterns={
        rounded:$('input[name="pattern"][value="rounded"]').checked,
        repdigit:$('input[name="pattern"][value="repdigit"]').checked,
      };
      return {start,label,units,patterns};
    }

    function recompute(){
      const o=getOptsFromForm(); if(!o) return;
      state.start=o.start; state.label=o.label; state.units=o.units; state.patterns=o.patterns;

      // Year selects depend on start year
      const startYear = state.start.getFullYear();
      if(!$('#yearFrom').options.length){
        fillYearFromSelect(startYear);
        setDefaultYearRange(startYear);
      } else {
        const prevStartYear = parseInt($('#yearFrom').options[0]?.value||String(startYear),10);
        if(prevStartYear !== startYear){
          const prevFrom = parseInt($('#yearFrom').value,10);
          const prevTo   = parseInt($('#yearTo').value,10);
          const fromOffset = prevFrom - prevStartYear;
          const toOffset   = prevTo - prevStartYear;

          fillYearFromSelect(startYear);
          let newFrom = startYear + Math.max(0, fromOffset);
          let newTo   = startYear + Math.max(0, toOffset);
          newFrom = Math.max(startYear, Math.min(startYear+MAX_SPAN, newFrom));
          newTo   = Math.max(newFrom, Math.min(startYear+MAX_SPAN, newTo));
          $('#yearFrom').value = String(newFrom);
          fillYearToSelect(startYear, newFrom);
          $('#yearTo').value = String(newTo);
        }
      }

      // Final validity + state sync
      ensureYearRangeValidity();

      // Build absolute window from year range
      const fromDate=new Date(state.yearFrom,0,1,0,0,0);
      const toDate  =new Date(state.yearTo,11,31,23,59,59);

      state.eventsAll=computeRangeWindow(state.start,{label:state.label,units:state.units,patterns:state.patterns}, fromDate, toDate);
      state.eventsView=state.eventsAll;
      encodeStateToURL();
      render();
    }

    function render(){
      if(!state.eventsView.length){
        $('#results').innerHTML='<div class="empty">Keine Eintr√§ge im Zeitraum. Passe Einheiten/Muster oder den Jahresbereich an.</div>';
        $('#btnIcsSel').disabled=true;
        updateDownloadTooltip();
        return;
      }
      let html='<div class="list">', year=null;
      const now=new Date();
      for(const ev of state.eventsView){
        const y=ev.date.getFullYear();
        if(y!==year){
          year=y;
          html+=`
            <div class="year-sep" id="y-${y}" data-year="${y}">
              <span class="y">${y}</span>
              <div class="controls">
                <button class="btn small secondary" data-year="${y}" data-act="all">‚úÖ Alle ausw√§hlen</button>
                <button class="btn small secondary" data-year="${y}" data-act="none">üö´ Alle abw√§hlen</button>
              </div>
            </div>`;
        }
        const checked=state.selected.has(ev.id)?'checked':'';
        const unitLabel={years:'Jahre',months:'Monate',weeks:'Wochen',days:'Tage',hours:'Stunden',minutes:'Minuten',seconds:'Sekunden'}[ev.unit];
        const whenText = `<span class="ttl-num">${ev.baseTitle}</span> <span class="since"> seit ${state.label||'Start'}</span>`;
        const rel=humanDiff(now, ev.date);
        html+=`
          <div class="item" data-year="${y}">
            <input type="checkbox" aria-label="ausw√§hlen" data-id="${ev.id}" ${checked} />
            <div class="grow">
              <div class="when">${whenText}</div>
              <div class="sub">${fmtFull.format(ev.date)} ‚Ä¢ ${rel}</div>
            </div>
            <span class="tag ${ev.unit}">${unitLabel}</span>
          </div>`;
      }
      html+='</div>';
      $('#results').innerHTML=html;

      // Checkbox toggle
      $$('#results input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change',e=>{
          const id=e.target.getAttribute('data-id');
          if(e.target.checked) state.selected.add(id); else state.selected.delete(id);
          $('#btnIcsSel').disabled=visibleSelected().length===0;
          updateDownloadTooltip();
        });
      });

      // Year-block controls (event delegation per render)
      $('#results').addEventListener('click',e=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const year=btn.getAttribute('data-year'); const act=btn.getAttribute('data-act');
        const idsInYear = state.eventsView.filter(ev=>ev.date.getFullYear()==year).map(ev=>ev.id);
        if(act==='all'){ idsInYear.forEach(id=>state.selected.add(id)); }
        if(act==='none'){ idsInYear.forEach(id=>state.selected.delete(id)); }
        render(); // sync
      }, {once:true});

      $('#btnIcsSel').disabled=visibleSelected().length===0;
      updateDownloadTooltip();
    }

    // Only selected & visible
    function visibleSelected(){
      const visSet=new Set(state.eventsView.map(ev=>ev.id));
      return state.eventsAll.filter(ev=>visSet.has(ev.id) && state.selected.has(ev.id));
    }

    // --- Download-Tooltip aktualisieren ---
    function updateDownloadTooltip(){
      const btn = $('#btnIcsSel');
      if(!btn) return;
      const n = visibleSelected().length;
      btn.title = n
        ? `Kalenderdatei f√ºr ${n} Ereignis${n===1?'':'se'} im .ics-Format herunterladen`
        : 'Keine ausgew√§hlten sichtbaren Eintr√§ge';
    }

    // ---------- Actions ----------
    function toLocalDateInputValue(d){const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);return z.toISOString().slice(0,10);}

    // Debounce for snappy UX
    let tmr=null;
    const schedule=()=>{ clearTimeout(tmr); tmr=setTimeout(recompute,120); };

    $('#label').addEventListener('input', schedule);
    $('#date').addEventListener('change', schedule);
    $('#time').addEventListener('change', schedule);
    $$('#form input[name="unit"]').forEach(i=>i.addEventListener('change', schedule));
    $$('#form input[name="pattern"]').forEach(i=>i.addEventListener('change', schedule));
    $('#yearFrom').addEventListener('change', ()=>{
      const startYear = state.start?.getFullYear() ?? new Date($('#date').value).getFullYear();
      const from = parseInt($('#yearFrom').value,10);
      fillYearToSelect(startYear, from);
      const toSel = $('#yearTo');
      const existing = toSel.value;
      if(!existing || parseInt(existing,10) < from) toSel.value = String(from);
      schedule();
    });
    $('#yearTo').addEventListener('change', schedule);

    $('#btnReset').addEventListener('click',()=>{
      $('#label').value='';
      $('#time').value='';
      const today=new Date();
      $('#date').value=toLocalDateInputValue(today);
      state.selected.clear();
      history.replaceState(null,'',location.pathname);
      // rebuild year selects for today
      const sy=today.getFullYear();
      fillYearFromSelect(sy);
      setDefaultYearRange(sy);
      recompute();
    });

    // Selection (toolbar acts only on visible)
    $('#btnSelectAll').addEventListener('click',()=>{ for(const ev of state.eventsView) state.selected.add(ev.id); render(); });
    $('#btnSelectNone').addEventListener('click',()=>{ for(const ev of state.eventsView) state.selected.delete(ev.id); render(); });

    // ICS export (only selected & visible)
    $('#btnIcsSel').addEventListener('click',()=>{
      const subset=visibleSelected();
      if(!subset.length) return;
      const ics=buildICS(subset);
      const label=(state.label||'Jubilaeum').toLowerCase().replace(/\s+/g,'_');
      download(`${label}_auswahl.ics`,ics);
    });

    // Bootstrap
    (function init(){
      const d=new Date(); $('#date').value=toLocalDateInputValue(d);
      $('#time').value='';
      loadStateFromURL();
      const dateStr=$('#date').value;
      const sy = dateStr ? new Date(dateStr).getFullYear() : new Date().getFullYear();
      fillYearFromSelect(sy);
      setDefaultYearRange(sy);
      recompute();
    })();
  </script>
</body>
</html>
