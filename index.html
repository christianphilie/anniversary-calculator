<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jubil√§ums‚ÄëFinder v2</title>
  <meta name="description" content="Berechne besondere Jubil√§en (z.‚ÄØB. 1000 Tage, 100 Wochen, 333‚ÄØ000 Sekunden) ab einem Startdatum und exportiere sie als .ics‚ÄëKalender. Hell/Dunkel/System, 10‚ÄëJahres‚ÄëBl√∂cke." />
  <style>
    /* =====================
       THEME TOKENS
       ===================== */
    :root{
      /* Light (default) */
      --bg: #ffffff;
      --panel: #f7f7fb;
      --muted: #555;
      --text: #111;
      --brand: #0ea5e9; /* cyan */
      --accent: #8b5cf6; /* violet */
      --ok: #10b981;     /* green */
      --warn: #f59e0b;   /* amber */
      --danger: #ef4444; /* red */
      --card: #fff;
      --border: #e5e7eb;
      --shadow: 0 2px 8px rgba(0,0,0,.08);
      --radius: 12px;
    }
    [data-theme="dark"]{
      --bg: #0b0c0f;
      --panel: #111318;
      --muted: #a3adba;
      --text: #e9eef5;
      --brand: #7dd3fc;
      --accent: #a78bfa;
      --ok: #34d399;
      --warn: #fbbf24;
      --danger: #f87171;
      --card: #141821;
      --border: #1f2530;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    /* =====================
       LAYOUT & BASICS
       ===================== */
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:var(--bg);
      transition: background .25s ease, color .25s ease;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:20px}
    .title{display:flex; gap:14px; align-items:center}
    .logo{width:44px; height:44px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--brand)); box-shadow:var(--shadow)}
    .logo span{font-weight:800; color:#fff}
    h1{font-size:20px; margin:0}
    .muted{color:var(--muted)}

    .theme-toggle{display:flex; gap:8px}
    .theme-toggle button{padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--card); cursor:pointer; font-size:13px}
    .theme-toggle button[aria-pressed="true"]{outline:2px solid var(--brand)}

    .grid{display:grid; grid-template-columns: 360px 1fr; gap:20px}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

    .panel{background:var(--panel); border:1px solid var(--border); border-radius: var(--radius); box-shadow:var(--shadow)}
    .panel .hd{padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .panel .bd{padding:18px}

    form .field{display:grid; gap:8px; margin-bottom:14px}
    label{font-size:13px; color:var(--muted)}
    input[type="text"], input[type="date"], input[type="time"]{
      background: var(--card); border:1px solid var(--border); color:var(--text);
      border-radius: 12px; padding:12px 12px; font-size:14px; outline:none; width:100%;
    }
    input[type="checkbox"]{ width:16px; height:16px }
    .row{display:flex; gap:10px}
    .row > * { flex:1 }

    .chips{display:flex; flex-wrap:wrap; gap:10px}
    .chip{display:inline-flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); padding:8px 10px; border-radius:999px; font-size:13px}

    .btn{appearance:none; cursor:pointer; background:linear-gradient(135deg, var(--brand), var(--accent)); color:#fff; font-weight:700; border:none; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow)}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid var(--border)}
    .btn.ghost{background:transparent; color:var(--muted); border:none}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* LIST */
    .list{display:grid; gap:10px}
    .item{display:flex; gap:14px; align-items:center; background:var(--card); border:1px solid var(--border); padding:12px; border-radius:14px}
    .when{font-weight:700}
    .sub{font-size:12px; color:var(--muted)}
    .grow{flex:1}
    .tag{font-size:12px; color:#fff; padding:3px 8px; border-radius:999px; font-weight:800; margin-left:auto}
    .tag.years{background:var(--brand)}
    .tag.months{background:var(--accent)}
    .tag.weeks{background:var(--ok)}
    .tag.days{background:var(--warn)}
    .tag.hours{background:var(--danger)}
    .tag.minutes{background:#16a34a}
    .tag.seconds{background:#d97706}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}

    .empty{padding:18px; background:var(--card); border:1px solid var(--border); border-radius:12px; text-align:center; color:var(--muted)}

    footer{margin-top:26px; color:var(--muted); font-size:12px}
    a { color: var(--brand) }
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#eef2ff; border:1px solid #c7d2fe; padding:2px 6px; border-radius:6px; font-size:12px}
    [data-theme="dark"] .kbd{background:#0f172a; border:1px solid #1f2937}
  </style>
</head>
<body data-theme="light" data-theme-mode="system">
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo"><span>üéâ</span></div>
        <div>
          <h1>Jubil√§ums‚ÄëFinder</h1>
          <div class="muted">Berechne besondere Meilensteine & exportiere sie als Kalender (.ics)</div>
        </div>
      </div>
      <div class="theme-toggle" role="group" aria-label="Theme">
        <button data-mode="light" aria-pressed="false" title="Hell">‚òÄÔ∏è</button>
        <button data-mode="dark" aria-pressed="false" title="Dunkel">üåô</button>
        <button data-mode="system" aria-pressed="true" title="System">üíª</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="hd"><strong>üéØ Eingaben</strong><button id="btnReset" class="btn ghost" title="Eingaben zur√ºcksetzen">Zur√ºcksetzen</button></div>
        <div class="bd">
          <form id="form">
            <div class="field">
              <label for="label">Titel / Anlass (optional, z.‚ÄØB. ‚ÄûHochzeit‚Äú)</label>
              <input id="label" type="text" placeholder="Hochzeit, erstes Date, neuer Job‚Ä¶" />
            </div>

            <div class="row">
              <div class="field">
                <label for="date">Startdatum</label>
                <input id="date" type="date" required />
              </div>
              <div class="field">
                <input id="time" type="time" step="1" />
              </div>
            </div>

            <div class="field">
              <label>Einheiten</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" name="unit" value="years" checked/> Jahre</label>
                <label class="chip"><input type="checkbox" name="unit" value="months" checked/> Monate</label>
                <label class="chip"><input type="checkbox" name="unit" value="weeks" checked/> Wochen</label>
                <label class="chip"><input type="checkbox" name="unit" value="days" checked/> Tage</label>
                <label class="chip"><input type="checkbox" name="unit" value="hours" checked/> Stunden</label>
                <label class="chip"><input type="checkbox" name="unit" value="minutes" checked/> Minuten</label>
                <label class="chip"><input type="checkbox" name="unit" value="seconds" checked/> Sekunden</label>
              </div>
            </div>

            <div class="field">
              <label>Besondere Muster</label>
              <div class="chips">
                <label class="chip"><input type="checkbox" name="pattern" value="pow10" checked/> 10^k (100, 1000, ‚Ä¶)</label>
                <label class="chip"><input type="checkbox" name="pattern" value="fivePow10" checked/> 5√ó10^k (5, 50, 500, ‚Ä¶)</label>
                <label class="chip"><input type="checkbox" name="pattern" value="repdigit" checked/> Schnapszahlen (11, 222, 3333, ‚Ä¶)</label>
                <label class="chip"><input type="checkbox" name="pattern" value="repdigitPow10"/> Schnaps√ó10^k (z.‚ÄØB. 333‚ÄØ000)</label>
              </div>
            </div>

            <div class="row" style="margin-top:8px">
              <button class="btn" id="btnGenerate" type="submit">Jubil√§en ausrechnen</button>
            </div>
          </form>
        </div>
      </section>

      <section class="panel">
        <div class="hd">
          <strong>üìä Ergebnisse</strong>
          <div class="toolbar">
            <div class="spacer"></div>
            <button class="btn secondary" id="btnIcsSel" title="Gew√§hlte Eintr√§ge exportieren" disabled>.ics ausgew√§hlt</button>
            <button class="btn" id="btnIcsAll" title="Alle angezeigten Eintr√§ge exportieren" disabled>.ics alle</button>
          </div>
        </div>
        <div class="bd" id="results">
          <div class="empty">Noch nichts berechnet. W√§hle oben ein Datum und klicke <span class="kbd">Jubil√§en ausrechnen</span>.</div>
        </div>
        <div class="bd" id="moreWrap" style="display:none">
          <button class="btn secondary" id="btnMore">Weitere 10 Jahre laden</button>
        </div>
      </section>
    </div>

    <footer>
      <p>üí° Tipp: Du kannst nach dem Export die .ics in jeden Kalender importieren (Apple, Google, Outlook, ‚Ä¶). Ereignisse sind einst√ºndig (UTC). </p>
    </footer>
  </div>

  <script>
  // ---------- Helpers ----------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  // Theme handling (light/dark/system) with persistence
  const body = document.body;
  const mm = window.matchMedia('(prefers-color-scheme: dark)');
  function applyTheme(mode){
    if(mode==='system'){
      body.setAttribute('data-theme', mm.matches? 'dark':'light');
      body.dataset.themeMode = 'system';
    }else{
      body.setAttribute('data-theme', mode);
      body.dataset.themeMode = mode;
    }
    // UI state
    $$('.theme-toggle button').forEach(b=>b.setAttribute('aria-pressed','false'));
    const btn = $(`.theme-toggle button[data-mode="${mode}"]`);
    if(btn) btn.setAttribute('aria-pressed','true');
    // persist
    localStorage.setItem('themeMode', mode);
  }
  $$('.theme-toggle button').forEach(btn=>{
    btn.addEventListener('click', ()=> applyTheme(btn.getAttribute('data-mode')));
  });
  mm.addEventListener?.('change', ()=>{ if((localStorage.getItem('themeMode')||'system')==='system') applyTheme('system'); });
  applyTheme(localStorage.getItem('themeMode')||'system');

  // Intl formatters
  const fmtFull = new Intl.DateTimeFormat('de-DE', { dateStyle: 'full', timeStyle: 'short' });
  const fmtDate = new Intl.DateTimeFormat('de-DE', { dateStyle: 'medium' });
  const fmtNum = new Intl.NumberFormat('de-DE');

  // Durations
  const MS = { second: 1000, minute: 60_000, hour: 3_600_000, day: 86_400_000, week: 7*86_400_000 };

  // Robust adders with month/day clamping
  function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }
  function addYears(d, n){
    const dt = new Date(d.getTime());
    const y = dt.getFullYear() + n;
    const m = dt.getMonth();
    const day = dt.getDate();
    const dim = daysInMonth(y, m);
    dt.setFullYear(y, m, Math.min(day, dim));
    return dt;
  }
  function addMonths(d, n){
    const dt = new Date(d.getTime());
    const y = dt.getFullYear();
    const m = dt.getMonth();
    const day = dt.getDate();
    const targetM = m + n;
    const ny = y + Math.floor(targetM / 12);
    const nm = ((targetM % 12) + 12) % 12;
    const dim = daysInMonth(ny, nm);
    dt.setFullYear(ny, nm, Math.min(day, dim));
    return dt;
  }
  function addWeeks(d, n){ return new Date(d.getTime() + n*MS.week); }
  function addDays(d, n){ return new Date(d.getTime() + n*MS.day); }
  function addHours(d, n){ return new Date(d.getTime() + n*MS.hour); }
  function addMinutes(d, n){ return new Date(d.getTime() + n*MS.minute); }
  function addSeconds(d, n){ return new Date(d.getTime() + n*MS.second); }

  // Patterns
  function makeRepdigits(max){
    const set = new Set();
    for(let len=2; len<=12; len++){
      for(let d=1; d<=9; d++){
        const val = Number(String(d).repeat(len));
        if(val<=max) set.add(val);
      }
    }
    return set;
  }
  function makeRepdigitsTimesPow10(max){
    const set = new Set();
    for(let len=2; len<=12; len++){
      for(let d=1; d<=9; d++){
        for(let k=1; k<=12; k++){
          const val = Number(String(d).repeat(len)) * 10**k;
          if(val<=max) set.add(val);
        }
      }
    }
    return set;
  }
  function makePowersOf10(max){ const set=new Set(); for(let k=1; 10**k<=max; k++) set.add(10**k); return set; }
  function makeFiveTimesPow10(max){ const set=new Set(); for(let k=0; 5*10**k<=max; k++) set.add(5*10**k); return set; }

  function buildCandidates(maxN, patterns){
    let s=new Set();
    if(patterns.pow10) for(const v of makePowersOf10(maxN)) s.add(v);
    if(patterns.fivePow10) for(const v of makeFiveTimesPow10(maxN)) s.add(v);
    if(patterns.repdigit) for(const v of makeRepdigits(maxN)) s.add(v);
    if(patterns.repdigitPow10) for(const v of makeRepdigitsTimesPow10(maxN)) s.add(v);
    return Array.from(s).sort((a,b)=>a-b);
  }

  // Grammar helpers (Dativ in Zeitangaben: in X Monaten, in X Jahren, ‚Ä¶)
  const unitDE = {
    years: ['Jahr','Jahre','Jahren'],
    months:['Monat','Monate','Monaten'],
    weeks: ['Woche','Wochen','Wochen'],
    days:  ['Tag','Tage','Tagen'],
    hours: ['Stunde','Stunden','Stunden'],
    minutes:['Minute','Minuten','Minuten'],
    seconds:['Sekunde','Sekunden','Sekunden'],
  };
  function labelDE(unit, n){ const [sg, pl] = unitDE[unit]; return n===1? sg : pl; }
  function dativeDE(unit, n){ const [sg, , datPl] = unitDE[unit]; return n===1? sg : datPl; }

  function inHuman(from, to){
    const ms = to - from;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const h = Math.floor(m/60);
    const d = Math.floor(h/24);
    const mo = Math.floor(d/30.44);
    const y = Math.floor(d/365.2425);
    if(y>0) return `in ${y} ${dativeDE('years', y)}`;
    if(mo>0) return `in ${mo} ${dativeDE('months', mo)}`;
    const w = Math.floor(d/7);
    if(w>0) return `in ${w} ${dativeDE('weeks', w)}`;
    if(d>0) return `in ${d} ${dativeDE('days', d)}`;
    if(h>0) return `in ${h} ${dativeDE('hours', h)}`;
    if(m>0) return `in ${m} ${dativeDE('minutes', m)}`;
    return `in ${s} ${dativeDE('seconds', s)}`;
  }

  // ICS helpers
  function isoDateTimeUTC(d){
    const pad = (n)=> String(n).padStart(2,'0');
    return (
      d.getUTCFullYear().toString()+
      pad(d.getUTCMonth()+1)+
      pad(d.getUTCDate())+'T'+
      pad(d.getUTCHours())+
      pad(d.getUTCMinutes())+
      pad(d.getUTCSeconds())+'Z'
    );
  }
  function escapeICS(text){
    return text.replace(/\\/g, "\\\\").replace(/\n/g, "\\n").replace(/,/g, "\\,").replace(/;/g, "\\;");
  }
  function buildICS(events){
    const now = new Date();
    let ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//JubilaeumsFinder//DE',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
    ];
    for(const ev of events){
      const uid = `${ev.id}@jubilaeum`;
      ics.push('BEGIN:VEVENT');
      ics.push(`UID:${uid}`);
      ics.push(`DTSTAMP:${isoDateTimeUTC(now)}`);
      ics.push(`SUMMARY:${escapeICS(ev.title)}`);
      ics.push(`DESCRIPTION:${escapeICS(ev.desc)}`);
      ics.push(`DTSTART:${isoDateTimeUTC(ev.date)}`);
      ics.push(`DTEND:${isoDateTimeUTC(new Date(ev.date.getTime()+60*60*1000))}`);
      ics.push('END:VEVENT');
    }
    ics.push('END:VCALENDAR');
    return ics.join('\r\n');
  }
  function download(filename, content){
    const blob = new Blob([content], {type:'text/calendar;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  // Core compute
  function unitAdder(unit){ return ({years:addYears, months:addMonths, weeks:addWeeks, days:addDays, hours:addHours, minutes:addMinutes, seconds:addSeconds})[unit]; }
  function unitMs(unit){ return ({weeks:MS.week, days:MS.day, hours:MS.hour, minutes:MS.minute, seconds:MS.second})[unit] || null; }

  function diffMonths(a, b){ return (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth()); }
  function yearsBetween(a,b){ return Math.floor((b - a)/MS.day / 365.2425); }

  function computeRange(start, opts, end){
    const now = new Date();
    const events = [];

    function pushEvent(date, n, unit){
      if(date < now || date > end) return;
      const title = `${fmtNum.format(n)} ${labelDE(unit,n)} seit ${opts.label||'Start'}`;
      const short = `${fmtNum.format(n)} ${labelDE(unit,n)}`;
      const startText = new Intl.DateTimeFormat('de-DE',{ dateStyle:'long', timeStyle:'short' }).format(start) + ' Uhr';
      const desc = `${fmtNum.format(n)} ${labelDE(unit,n)} seit ${startText}`;
      events.push({
        id: `${unit}-${n}-${date.getTime()}`,
        unit, n, date, title, short,
        inHuman: inHuman(now, date),
        tag: unit,
        desc,
      });
    }

    const units = opts.units;
    const patterns = opts.patterns;

    for(const unit of units){
      const add = unitAdder(unit);
      if(unit==='years'){
        const maxN = yearsBetween(start, end) + 2; // a bit generous
        for(const n of buildCandidates(maxN, patterns)){
          pushEvent(add(start, n), n, unit);
        }
      }else if(unit==='months'){
        const maxN = diffMonths(start, end) + 2;
        for(const n of buildCandidates(maxN, patterns)){
          pushEvent(add(start, n), n, unit);
        }
      }else{
        const per = unitMs(unit);
        const maxN = Math.floor((end - start)/per) + 1;
        for(const n of buildCandidates(maxN, patterns)){
          pushEvent(add(start, n), n, unit);
        }
      }
    }

    events.sort((a,b)=> a.date - b.date || a.n - b.n);
    return events;
  }

  // ---------- State & Rendering ----------
  const state = {
    start: null,
    label: '',
    units: ['years','months','weeks','days','hours','minutes','seconds'],
    patterns: { pow10:true, fivePow10:true, repdigit:true, repdigitPow10:true },
    blockYears: 10,
    loadedBlocks: 0, // how many 10y blocks loaded
    events: [],
    selected: new Set(),
  };

  function renderEmpty(){
    $('#results').innerHTML = '<div class="empty">Keine Eintr√§ge im Zeitraum. Pr√ºfe Einheiten/Muster oder lade weitere Jahre.</div>';
    $('#btnIcsAll').disabled = true;
    $('#btnIcsSel').disabled = true;
    $('#moreWrap').style.display = 'none';
  }

  function renderList(){
    if(!state.events.length) return renderEmpty();
    const rows = state.events.map(ev=>{
      const checked = state.selected.has(ev.id) ? 'checked' : '';
      const tagText = ({years:'Jahre', months:'Monate', weeks:'Wochen', days:'Tage', hours:'Stunden', minutes:'Minuten', seconds:'Sekunden'})[ev.tag];
      return `
        <div class="item">
          <input type="checkbox" aria-label="ausw√§hlen" data-id="${ev.id}" ${checked} />
          <div class="grow">
            <div class="when">${ev.title}</div>
            <div class="sub">${fmtFull.format(ev.date)} ‚Ä¢ ${ev.inHuman}</div>
          </div>
          <span class="tag ${ev.tag}">${tagText}</span>
        </div>`;
    }).join('');
    $('#results').innerHTML = `<div class="list">${rows}</div>`;

    // listeners for checkboxes
    $$('#results input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', e=>{
        const id = e.target.getAttribute('data-id');
        if(e.target.checked) state.selected.add(id); else state.selected.delete(id);
        $('#btnIcsSel').disabled = state.selected.size===0;
      });
    });

    $('#btnIcsAll').disabled = false;
    $('#btnIcsSel').disabled = state.selected.size===0;

    // show load more
    $('#moreWrap').style.display = 'block';
  }

  function render(){ renderList(); }

  // ---------- Wire‚Äëup ----------
  function toLocalDateInputValue(d){ const z = new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }

  function getOpts(){
    const label = $('#label').value.trim();
    const dateStr = $('#date').value; if(!dateStr) return null;
    const timeStr = $('#time').value || '12:00:00';
    const [hh, mm, ss='00'] = timeStr.split(':');
    const [y,m,d] = dateStr.split('-').map(Number);
    const start = new Date(y, m-1, d, Number(hh), Number(mm), Number(ss));

    const units = $$('input[name="unit"]:checked').map(x=>x.value);
    const patterns = {
      pow10: $('input[name="pattern"][value="pow10"]').checked,
      fivePow10: $('input[name="pattern"][value="fivePow10"]').checked,
      repdigit: $('input[name="pattern"][value="repdigit"]').checked,
      repdigitPow10: $('input[name="pattern"][value="repdigitPow10"]').checked,
    };

    return { start, label, units, patterns };
  }

  function recomputeInitial(){
    const o = getOpts(); if(!o) return;
    state.start = o.start; state.label = o.label; state.units = o.units; state.patterns = o.patterns;
    state.loadedBlocks = 1; state.selected.clear();
    const now = new Date();
    const end = addYears(now, state.blockYears * state.loadedBlocks);
    const events = computeRange(state.start, {label:state.label, units:state.units, patterns:state.patterns}, end);
    state.events = events;
    render();
  }

  function loadMore(){
    if(!state.start) return;
    const now = new Date();
    const prevBlocks = state.loadedBlocks;
    state.loadedBlocks += 1;
    const oldEnd = addYears(now, state.blockYears * prevBlocks);
    const newEnd = addYears(now, state.blockYears * state.loadedBlocks);
    const more = computeRange(state.start, {label:state.label, units:state.units, patterns:state.patterns}, newEnd)
      .filter(ev => ev.date > oldEnd);
    // merge
    const ids = new Set(state.events.map(e=>e.id));
    for(const ev of more){ if(!ids.has(ev.id)) state.events.push(ev); }
    state.events.sort((a,b)=> a.date - b.date || a.n - b.n);
    render();
  }

  $('#form').addEventListener('submit', e=>{ e.preventDefault(); recomputeInitial(); });
  $('#btnReset').addEventListener('click', ()=>{ $('#label').value=''; $('#date').value=''; $('#time').value=''; state.events=[]; state.selected.clear(); renderEmpty(); });
  $('#btnMore').addEventListener('click', loadMore);

  // ICS buttons
  $('#btnIcsAll').addEventListener('click', ()=>{
    if(!state.events.length) return;
    const ics = buildICS(state.events);
    const label = (state.label || 'Jubilaeum').toLowerCase().replace(/\s+/g,'_');
    download(`${label}_alle.ics`, ics);
  });
  $('#btnIcsSel').addEventListener('click', ()=>{
    if(!state.selected.size) return;
    const subset = state.events.filter(ev=>state.selected.has(ev.id));
    const ics = buildICS(subset);
    const label = (state.label || 'Jubilaeum').toLowerCase().replace(/\s+/g,'_');
    download(`${label}_auswahl.ics`, ics);
  });

  // Prefill today
  $('#date').value = toLocalDateInputValue(new Date());

  // After first render, ensure "Load more" visibility reflects state
  renderEmpty();
  </script>
</body>
</html>
