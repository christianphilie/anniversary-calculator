<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jubil√§ums‚ÄëRechner</title>
  <style>
    :root{
      --bg: #0b0c0f;
      --panel:#121418;
      --muted:#9aa3af;
      --text:#e5e7eb;
      --accent:#7c3aed;
      --accent-2:#22d3ee;
      --ring: rgba(124,58,237,0.45);
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b0c0f 0%, #0e1015 100%);
      color:var(--text); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .container{ max-width:1180px; margin:0 auto; padding:24px; }
    header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .title{ font-size: clamp(22px, 3vw, 32px); font-weight:700; letter-spacing:0.2px; }
    .subtitle{ color:var(--muted); font-size:14px }

    .panel{ background:linear-gradient(180deg,#121418 0%, #0f1116 100%); border:1px solid #1f2430; border-radius:var(--radius); padding:16px; }
    .grid{ display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-weight:600; margin-bottom:6px; }
    .muted{ color:var(--muted); font-size:12px }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }

    input[type="text"], input[type="date"], select{
      width:100%; padding:10px 12px; color:var(--text); background:#0d0f14; border:1px solid #1f2430; border-radius:10px; outline:none;
    }
    input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1) opacity(0.7); }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ position:relative; display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:#0d0f14; border:1px solid #1f2430; border-radius:999px; cursor:pointer; user-select:none; }
    .chip input{ appearance:none; width:16px; height:16px; border-radius:4px; border:1px solid #303646; display:inline-block; position:relative; }
    .chip input:checked{ background: conic-gradient(from 180deg at 50% 50%, var(--accent), var(--accent-2)); border-color:transparent; }
    .chip span{ font-size:13px }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{ cursor:pointer; border:1px solid #2a3141; background:#12161e; color:var(--text); padding:10px 12px; border-radius:10px; font-weight:600; }
    button.primary{ background:linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%); border-color:#6d28d9; }
    button.ghost{ background:transparent; }
    button:focus-visible{ outline: 2px solid var(--ring); outline-offset:2px; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .tabs{ display:flex; gap:8px; margin-top:12px; }
    .tab{ padding:8px 12px; border-radius:10px; border:1px solid #262c3a; background:#0d0f14; color:var(--muted); font-weight:600; cursor:pointer; }
    .tab.active{ color:var(--text); border-color:#3a4255; background:#12161e }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{ display:grid; grid-template-columns: 28px 1fr auto; gap:12px; align-items:center; padding:12px; border:1px solid #1f2430; border-radius:12px; background:#0d0f14; }
    .item .date{ font-weight:700 }
    .item .meta{ color:var(--muted); font-size:12px }

    .calendar{ margin-top:8px; }
    .cal-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .cal-title{ font-weight:700; letter-spacing:.2px }
    .cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .dow{ color:var(--muted); text-align:center; font-size:12px; }
    .day{ min-height:80px; border:1px solid #1f2430; border-radius:10px; background:#0d0f14; padding:6px; position:relative; }
    .day.out{ opacity:.35 }
    .day .num{ font-size:12px; color:var(--muted) }
    .badge{ position:absolute; right:6px; bottom:6px; font-size:11px; background: #202634; border:1px solid #2a3141; padding:3px 6px; border-radius:999px; }

    .legend{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .pill{ font-size:12px; border:1px solid #2a3141; padding:4px 8px; border-radius:999px; }

    .day-events{ margin-top:12px; display:none }
    .day-events.active{ display:block }
    .hr{ height:1px; background:#1f2430; margin:10px 0 }
    .empty{ color:var(--muted); text-align:center; padding:12px }
    footer{ margin-top:18px; color:var(--muted); font-size:12px }
    .kbd{ border:1px solid #2a3141; background:#0d0f14; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">üéâ Jubil√§ums‚ÄëRechner</div>
        <div class="subtitle">Berechne skurrile & klassische Jubil√§en (10er‚ÄëPotenz, 5√ó10er, Schnapszahlen) f√ºr Jahre, Monate, Wochen, Tage, Stunden, Minuten und Sekunden ‚Äì und exportiere sie als ICS.</div>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row">
          <div style="flex:1 1 280px">
            <label for="name">Ereignisname</label>
            <input id="name" type="text" placeholder="z.‚ÄØB. Hochzeit" value="Ereignis" />
          </div>
          <div style="flex:1 1 220px">
            <label for="date">Ereignisdatum</label>
            <input id="date" type="date" />
            <div class="muted">Zeitzone: lokales System (ganzt√§gige Termine)</div>
          </div>
          <div style="flex:1 1 220px">
            <label for="horizon">Zeithorizont</label>
            <select id="horizon">
              <option value="P3M">N√§chste 3 Monate</option>
              <option value="P6M" selected>N√§chste 6 Monate</option>
              <option value="P1Y">N√§chstes Jahr</option>
              <option value="P2Y">N√§chste 2 Jahre</option>
              <option value="P5Y">N√§chste 5 Jahre</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1 1 420px">
            <label>Einheiten</label>
            <div id="units" class="chips"></div>
            <div class="muted">Tipp: F√ºr viele Treffer gen√ºgen Jahre, Monate, Wochen & Tage. Stunden/Minuten/Sekunden erzeugen nur 10er‚Äë/5√ó10er‚Äë/Schnapszahlen‚ÄëJubil√§en.</div>
          </div>
          <div style="flex:1 1 420px">
            <label>Kategorien</label>
            <div id="cats" class="chips"></div>
            <div class="muted">Schnapszahlen = gleiche Ziffern (111, 222, ‚Ä¶). 5‚ÄëJahres‚ÄëSchritte gelten nur f√ºr Jahre.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="actions">
          <button id="compute" class="primary">üîç Berechnen</button>
          <button id="selectAll" class="ghost">üìù Alle ausw√§hlen</button>
          <button id="clearSel" class="ghost">üßπ Auswahl l√∂schen</button>
          <span class="muted" id="countInfo"></span>
          <span style="flex:1"></span>
          <button id="icsSel" disabled>üìÖ Auswahl als .ics</button>
          <button id="icsAll" disabled>üì• Alle als .ics</button>
        </div>
      </section>

      <section class="panel">
        <div class="tabs">
          <button class="tab active" data-tab="list">üìù Liste</button>
          <button class="tab" data-tab="calendar">üìÜ Kalender</button>
        </div>
        <div id="view-list">
          <div class="list" id="list"></div>
          <div id="empty-list" class="empty">Noch nichts berechnet.</div>
        </div>
        <div id="view-calendar" style="display:none">
          <div class="calendar">
            <div class="cal-head">
              <button id="prevMonth">‚óÄ</button>
              <div class="cal-title" id="calTitle"></div>
              <button id="nextMonth">‚ñ∂</button>
            </div>
            <div class="cal-grid" id="dow"></div>
            <div class="cal-grid" id="cal"></div>
            <div class="legend">
              <span class="pill">‚Ä¢ Zehner‚ÄëPotenz</span>
              <span class="pill">‚Ä¢ 5√óZehner</span>
              <span class="pill">‚Ä¢ Schnapszahl</span>
              <span class="pill">‚Ä¢ 5‚ÄëJahre</span>
            </div>
            <div id="dayEvents" class="day-events"></div>
          </div>
          <div id="empty-cal" class="empty">Noch nichts berechnet.</div>
        </div>
      </section>
    </div>

    <footer>
      üìå Export: Alle Jubil√§en werden als <span class="kbd">ganzt√§gige</span> Termine erstellt (ohne Uhrzeit). Bei Bedarf kann sp√§ter eine Zeitangabe hinzugef√ºgt werden.
    </footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const fmtDE = new Intl.DateTimeFormat('de-DE', { weekday:'short', year:'numeric', month:'long', day:'numeric' });
    const fmtMonth = new Intl.DateTimeFormat('de-DE', { month:'long', year:'numeric' });
    const nfDE = new Intl.NumberFormat('de-DE');

    const Unit = {
      years: {key:'years', label:'Jahre'},
      months:{key:'months',label:'Monate'},
      weeks: {key:'weeks', label:'Wochen'},
      days:  {key:'days',  label:'Tage'},
      hours: {key:'hours', label:'Stunden'},
      minutes:{key:'minutes',label:'Minuten'},
      seconds:{key:'seconds',label:'Sekunden'},
    };

    const Categories = [
      {key:'pow10', label:'10er‚ÄëPotenz (10, 100, ‚Ä¶)', default:true},
      {key:'fivePow', label:'5√ó10er (5, 50, 500, ‚Ä¶)', default:true},
      {key:'schnaps', label:'Schnapszahlen (111, 222, ‚Ä¶)', default:true},
      {key:'fiveYears', label:'5‚ÄëJahres‚ÄëSchritte (nur Jahre)', default:true},
    ];

    function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

    function clampDateToMonth(y,m,day){ return new Date(y, m, Math.min(day, daysInMonth(y,m))); }

    function addYearsClamped(d, n){ const y=d.getFullYear()+n, m=d.getMonth(), day=d.getDate(); return clampDateToMonth(y,m,day); }
    function addMonthsClamped(d, n){ const y=d.getFullYear(), m=d.getMonth()+n, day=d.getDate(); const Y = y + Math.floor(m/12); const M = ((m%12)+12)%12; return clampDateToMonth(Y,M,day); }
    function addWeeks(d, n){ const x = new Date(d); x.setDate(x.getDate() + n*7); return x; }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate() + n); return x; }
    function addHours(d,n){ const x=new Date(d); x.setHours(x.getHours()+n); return x; }
    function addMinutes(d,n){ const x=new Date(d); x.setMinutes(x.getMinutes()+n); return x; }
    function addSeconds(d,n){ const x=new Date(d); x.setSeconds(x.getSeconds()+n); return x; }

    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }

    function formatISODate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

    function formatICSDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}${m}${day}`; }

    function nowLocal(){ return new Date(); }

    function parseISODuration(dur){
      // supports PnM / PnY with M=months, Y=years
      if(!dur.startsWith('P')) return {months:6};
      if(dur.endsWith('M')) return {months: parseInt(dur.slice(1)) };
      if(dur.endsWith('Y')) return {months: parseInt(dur.slice(1))*12 };
      return {months:6};
    }

    function isPowerOfTen(n){ if(n<1) return false; while(n%10===0) n/=10; return n===1; }
    function isFiveTimesPowerOfTen(n){ if(n<5) return false; n/=5; return isPowerOfTen(n); }
    function isRepdigit(n){ const s=String(n); if(s.length<2) return false; return s.split('').every(ch=>ch===s[0]); }

    function addByUnit(d0, unit, n){
      switch(unit){
        case 'years': return addYearsClamped(d0, n);
        case 'months': return addMonthsClamped(d0, n);
        case 'weeks': return addWeeks(d0, n);
        case 'days': return addDays(d0, n);
        case 'hours': return addHours(d0, n);
        case 'minutes': return addMinutes(d0, n);
        case 'seconds': return addSeconds(d0, n);
      }
    }

    function unitPlural(unit){ return Unit[unit].label; }

    function msBetween(a,b){ return b.getTime() - a.getTime(); }

    function diffUpperBoundN(d0, unit, tMax){
      // rough max N so we can bound Schnapszahlen digits
      const ms = msBetween(d0, tMax);
      switch(unit){
        case 'years': {
          const y = tMax.getFullYear() - d0.getFullYear();
          return Math.max(1,y+1);
        }
        case 'months': {
          let m = (tMax.getFullYear()-d0.getFullYear())*12 + (tMax.getMonth()-d0.getMonth()) + 2; // +2 buffer
          return Math.max(1,m);
        }
        case 'weeks': return Math.floor(ms / (7*24*3600e3)) + 4;
        case 'days': return Math.floor(ms / (24*3600e3)) + 7;
        case 'hours': return Math.floor(ms / (3600e3)) + 24;
        case 'minutes': return Math.floor(ms / (60e3)) + 60;
        case 'seconds': return Math.floor(ms / 1000) + 3600;
      }
    }

    function humanDiffFromToday(d){
      const today = startOfDay(nowLocal());
      const dd = Math.round((startOfDay(d) - today)/(24*3600e3));
      if(dd===0) return 'heute';
      if(dd===1) return 'morgen';
      if(dd>1) return `in ${nfDE.format(dd)} Tagen`;
      if(dd===-1) return 'gestern';
      return `${nfDE.format(Math.abs(dd))} Tage her`;
    }

    // ---------- UI init ----------
    const unitsDiv = document.getElementById('units');
    const catsDiv = document.getElementById('cats');

    const unitOrder = ['years','months','weeks','days','hours','minutes','seconds'];
    unitOrder.forEach(u=>{
      const id = `unit-${u}`;
      const chip = document.createElement('label');
      chip.className='chip';
      chip.innerHTML = `<input id="${id}" type="checkbox" ${['years','months','weeks','days'].includes(u)?'checked':''}><span>${Unit[u].label}</span>`;
      unitsDiv.appendChild(chip);
    });

    Categories.forEach(c=>{
      const id = `cat-${c.key}`;
      const chip = document.createElement('label');
      chip.className='chip';
      chip.innerHTML = `<input id="${id}" type="checkbox" ${c.default?'checked':''}><span>${c.label}</span>`;
      catsDiv.appendChild(chip);
    });

    // ---------- Core generation ----------
    let EVENTS = []; // computed events
    let SELECTED = new Set();

    function compute(){
      const name = document.getElementById('name').value.trim() || 'Ereignis';
      const dateStr = document.getElementById('date').value;
      if(!dateStr){ alert('Bitte ein Ereignisdatum w√§hlen.'); return; }
      const d0 = new Date(dateStr + 'T00:00:00');
      const horizon = parseISODuration(document.getElementById('horizon').value);
      const now = nowLocal();
      const tMin = startOfDay(now); // ab heute
      const tMax = addMonthsClamped(now, horizon.months);

      const enabledUnits = unitOrder.filter(u=>document.getElementById(`unit-${u}`).checked);
      const enabledCats = Categories.filter(c=>document.getElementById(`cat-${c.key}`).checked).map(c=>c.key);

      const results = [];

      for(const unit of enabledUnits){
        // helper: add candidate if within window
        const tryAdd = (n, catKey)=>{
          if(n<=0) return;
          const date = addByUnit(d0, unit, n);
          if(date >= tMin && date <= tMax){
            const label = `${nfDE.format(n)} ${unitPlural(unit)}`;
            results.push({ date, n, unit, label, name, category:catKey, iso:formatISODate(date) });
          }
        };

        // 10er‚ÄëPotenz
        if(enabledCats.includes('pow10')){
          let p = 10; // ab 10
          while(true){
            const d = addByUnit(d0, unit, p);
            if(d > tMax) break;
            if(d >= tMin) tryAdd(p,'pow10');
            p *= 10;
            if(p>1e12) break; // safety
          }
        }
        // 5√ó10er (5,50,500,‚Ä¶)
        if(enabledCats.includes('fivePow')){
          let q = 5;
          while(true){
            const d = addByUnit(d0, unit, q);
            if(d > tMax) break;
            if(d >= tMin) tryAdd(q,'fivePow');
            q *= 10;
            if(q>1e12) break;
          }
        }
        // 5‚ÄëJahres‚ÄëSchritte (nur Jahre)
        if(unit==='years' && enabledCats.includes('fiveYears')){
          // begin at smallest 5k that could be within window
          let k = 5;
          // Fast-forward roughly near window start
          const yearsToToday = now.getFullYear() - d0.getFullYear();
          if(yearsToToday>5){ k = Math.max(5, Math.floor(yearsToToday/5)*5); }
          // step backwards a bit to catch near boundary
          k = Math.max(5, k-10);
          while(true){
            const d = addYearsClamped(d0, k);
            if(d > tMax) break;
            if(d >= tMin) tryAdd(k,'fiveYears');
            k += 5;
            if(k>1000) break; // safety
          }
        }
        // Schnapszahlen (Repdigits)
        if(enabledCats.includes('schnaps')){
          const nMax = diffUpperBoundN(d0, unit, tMax);
          const maxDigits = Math.max(2, String(nMax).length);
          for(let digits=2; digits<=maxDigits; digits++){
            const repUnit = (10**digits - 1)/9; // 1..1 (digits times)
            for(let d=1; d<=9; d++){
              const n = d*repUnit;
              const dt = addByUnit(d0, unit, n);
              if(dt >= tMin && dt <= tMax) tryAdd(n, 'schnaps');
            }
          }
        }
      }

      // Deduplicate by (unit,n)
      const seen = new Set();
      EVENTS = results.filter(ev=>{
        const key = ev.unit + '|' + ev.n;
        if(seen.has(key)) return false; seen.add(key); return true;
      }).sort((a,b)=> a.date - b.date || a.unit.localeCompare(b.unit));
      SELECTED = new Set();
      render();
    }

    // ---------- Rendering ----------
    const listEl = document.getElementById('list');
    const countInfo = document.getElementById('countInfo');
    const emptyList = document.getElementById('empty-list');
    const icsAllBtn = document.getElementById('icsAll');
    const icsSelBtn = document.getElementById('icsSel');

    function render(){
      // Buttons
      icsAllBtn.disabled = EVENTS.length===0;
      icsSelBtn.disabled = SELECTED.size===0;
      countInfo.textContent = EVENTS.length? `${EVENTS.length} Treffer` : '';

      // List view
      listEl.innerHTML='';
      if(EVENTS.length===0){ emptyList.style.display='block'; } else { emptyList.style.display='none'; }

      EVENTS.forEach((ev, idx)=>{
        const item = document.createElement('div'); item.className='item';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = SELECTED.has(idx);
        cb.addEventListener('change',()=>{ if(cb.checked) SELECTED.add(idx); else SELECTED.delete(idx); icsSelBtn.disabled = SELECTED.size===0; });
        const main = document.createElement('div');
        const date = document.createElement('div'); date.className='date'; date.textContent = fmtDE.format(ev.date);
        const title = document.createElement('div'); title.textContent = `${ev.label} seit ${ev.name}`;
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${humanDiffFromToday(ev.date)} ‚Ä¢ Kategorie: ${categoryLabel(ev.category)} ‚Ä¢ Einheit: ${unitPlural(ev.unit)}`;
        main.append(date, title, meta);
        const actions = document.createElement('div');
        const btn = document.createElement('button'); btn.textContent='üìÖ .ics'; btn.title='Nur diesen Termin exportieren'; btn.addEventListener('click',()=>downloadICS([ev], `${sanitizeFile(`${ev.label} ‚Äì ${ev.name}`)}.ics`));
        actions.appendChild(btn);
        item.append(cb, main, actions);
        listEl.appendChild(item);
      });

      // Calendar view
      rebuildCalendar();
    }

    function categoryLabel(k){
      switch(k){
        case 'pow10': return 'Zehner‚ÄëPotenz';
        case 'fivePow': return '5√óZehner';
        case 'schnaps': return 'Schnapszahl';
        case 'fiveYears': return '5‚ÄëJahre';
        default: return k;
      }
    }

    function sanitizeFile(s){ return s.replace(/[\\/:*?"<>|]/g, '_'); }

    // ---------- Tabs ----------
    const tabs = document.querySelectorAll('.tab');
    const viewList = document.getElementById('view-list');
    const viewCal = document.getElementById('view-calendar');
    tabs.forEach(t=> t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const tab = t.dataset.tab;
      if(tab==='list'){ viewList.style.display='block'; viewCal.style.display='none'; }
      else { viewList.style.display='none'; viewCal.style.display='block'; }
    }));

    // ---------- Calendar ----------
    const dowEl = document.getElementById('dow');
    const calEl = document.getElementById('cal');
    const calTitle = document.getElementById('calTitle');
    const dayEvents = document.getElementById('dayEvents');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');

    const DOW = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    function buildDOW(){ dowEl.innerHTML=''; DOW.forEach(x=>{ const d=document.createElement('div'); d.className='dow'; d.textContent=x; dowEl.appendChild(d); }); }
    buildDOW();

    let calCursor = new Date(); calCursor.setDate(1);

    function rebuildCalendar(){
      if(EVENTS.length===0){ document.getElementById('empty-cal').style.display='block'; return; }
      document.getElementById('empty-cal').style.display='none';

      calTitle.textContent = fmtMonth.format(calCursor);
      calEl.innerHTML=''; dayEvents.classList.remove('active'); dayEvents.innerHTML='';

      // collect events by ISO date
      const map = new Map();
      for(const ev of EVENTS){ const k = formatISODate(ev.date); if(!map.has(k)) map.set(k, []); map.get(k).push(ev); }

      const y = calCursor.getFullYear();
      const m = calCursor.getMonth();
      const first = new Date(y, m, 1);
      const startIdx = (first.getDay()+6)%7; // Mon=0
      const days = daysInMonth(y,m);
      const cells = startIdx + days;
      const rows = Math.ceil(cells/7);

      for(let i=0;i<rows*7;i++){
        const cell = document.createElement('div'); cell.className='day';
        const dayNum = i - startIdx + 1;
        const inMonth = dayNum>=1 && dayNum<=days;
        let d;
        if(inMonth){ d = new Date(y,m,dayNum); } else {
          cell.classList.add('out');
          const prevDate = new Date(y,m,0); // last day prev month
          const nextDate = new Date(y,m+1,1); // first day next month
          if(dayNum<1) d = new Date(prevDate.getFullYear(), prevDate.getMonth(), prevDate.getDate()+dayNum);
          else d = new Date(nextDate.getFullYear(), nextDate.getMonth(), dayNum - days);
        }
        const iso = formatISODate(d);
        const num = document.createElement('div'); num.className='num'; num.textContent = String(d.getDate()); cell.appendChild(num);
        if(map.has(iso)){
          const evs = map.get(iso);
          const b = document.createElement('div'); b.className='badge'; b.textContent = evs.length===1? '‚Ä¢ 1' : `‚Ä¢ ${evs.length}`; cell.appendChild(b);
          cell.style.borderColor = '#2b3450';
          cell.style.boxShadow = 'inset 0 0 0 1px #2b3450';
          cell.style.cursor = 'pointer';
          cell.addEventListener('click',()=>showDayEvents(iso, evs));
        }
        calEl.appendChild(cell);
      }
    }

    function showDayEvents(iso, evs){
      dayEvents.classList.add('active');
      dayEvents.innerHTML = `<div style="font-weight:700; margin-bottom:6px">${fmtDE.format(new Date(iso))}</div>`;
      const list = document.createElement('div'); list.className='list';
      evs.forEach(ev=>{
        const idx = EVENTS.findIndex(x=> x.unit===ev.unit && x.n===ev.n);
        const row = document.createElement('div'); row.className='item';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = SELECTED.has(idx);
        cb.addEventListener('change',()=>{ if(cb.checked) SELECTED.add(idx); else SELECTED.delete(idx); icsSelBtn.disabled = SELECTED.size===0; });
        const main = document.createElement('div');
        const date = document.createElement('div'); date.className='date'; date.textContent = fmtDE.format(ev.date);
        const title = document.createElement('div'); title.textContent = `${ev.label} seit ${ev.name}`;
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${humanDiffFromToday(ev.date)} ‚Ä¢ Kategorie: ${categoryLabel(ev.category)} ‚Ä¢ Einheit: ${unitPlural(ev.unit)}`;
        main.append(date, title, meta);
        const actions = document.createElement('div');
        const btn = document.createElement('button'); btn.textContent='üìÖ .ics'; btn.addEventListener('click',()=>downloadICS([ev], `${sanitizeFile(`${ev.label} ‚Äì ${ev.name}`)}.ics`));
        actions.appendChild(btn);
        row.append(cb, main, actions);
        list.appendChild(row);
      });
      dayEvents.appendChild(list);
    }

    prevMonthBtn.addEventListener('click',()=>{ calCursor = addMonthsClamped(calCursor, -1); rebuildCalendar(); });
    nextMonthBtn.addEventListener('click',()=>{ calCursor = addMonthsClamped(calCursor, +1); rebuildCalendar(); });

    // ---------- ICS generation ----------
    function icsEscape(text){
      return text
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/\r/g, "")
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;");
    }

    function buildICS(events, calName='Jubil√§en'){ 
      const now = new Date();
      const dtstamp = now.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//JubiCalc//DE',
        'CALSCALE:GREGORIAN',
        `NAME:${icsEscape(calName)}`,
        `X-WR-CALNAME:${icsEscape(calName)}`,
      ];
      for(const ev of events){
        const start = formatICSDate(ev.date);
        const endDate = addDays(ev.date,1);
        const end = formatICSDate(endDate);
        const summary = `${ev.label} seit ${ev.name}`;
        const uid = `${start}-${ev.unit}-${ev.n}-${Math.random().toString(16).slice(2)}@jubicalc`;
        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${uid}`);
        lines.push(`DTSTAMP:${dtstamp}`);
        lines.push(`DTSTART;VALUE=DATE:${start}`);
        lines.push(`DTEND;VALUE=DATE:${end}`);
        lines.push(`SUMMARY:${icsEscape(summary)}`);
        lines.push(`DESCRIPTION:${icsEscape(`${categoryLabel(ev.category)} ‚Ä¢ ${ev.label} seit ${ev.name}`)}`);
        lines.push('END:VEVENT');
      }
      lines.push('END:VCALENDAR');
      return lines.join('\r\n');
    }

    function downloadICS(events, filename){
      const calName = `Jubil√§en ‚Äì ${events[0]?.name || 'Ereignis'}`;
      const ics = buildICS(events, calName);
      const blob = new Blob([ics], {type:'text/calendar'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename || 'jubil√§en.ics'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    // ---------- Wiring ----------
    document.getElementById('compute').addEventListener('click', compute);
    document.getElementById('selectAll').addEventListener('click', ()=>{ EVENTS.forEach((_,i)=>SELECTED.add(i)); render(); });
    document.getElementById('clearSel').addEventListener('click', ()=>{ SELECTED.clear(); render(); });
    document.getElementById('icsAll').addEventListener('click', ()=> downloadICS(EVENTS, 'jubil√§en_alle.ics'));
    document.getElementById('icsSel').addEventListener('click', ()=> downloadICS(Array.from(SELECTED).sort((a,b)=>a-b).map(i=>EVENTS[i]), 'jubil√§en_auswahl.ics'));

    // Prefill date input with an example? No ‚Äì leave empty to force deliberate choice.
  </script>
</body>
</html>